## 缓存穿透，缓存击穿，缓存雪崩，缓存数据失效问题解决方案
 缓存使用方式
 
![](https://user-gold-cdn.xitu.io/2019/3/27/169bb2607456de97?imageslim)

- **缓存穿透**
1. 缓存穿透概念
>请求查询一个压根不存在的数据，也就是缓存和数据库都查不到的数据，每次请求都直达数据，这种情况会导致大量的请求到数据库，
导致数据库宕机

2. 解决办法
>设置控制：数据库中未查到的数据统一都添加到缓存中，但是value设置为空并设置过期时间
>BloomFilter 布隆过滤器 用来判断某个元素是否在某个集合中。
在缓存之前加一层BloomFilter，查询时先在BloomFilter中查询一下，不存在直接返回，存在的话再走缓存 -> 查DB。
流程图如下：
![](https://user-gold-cdn.xitu.io/2019/3/27/169bb2638b91b339?imageslim)

- **缓存击穿**
1. 缓存击穿概念
> 在高并发情况下，大量的请求同时查询一个key时，恰巧此时key正好失效，导致大量的请求直接到达数据库。这种情况会导致某一时刻
数据库请求量过大，压力剧增
2. 如何解决
> 出现上面的情况是因为多个线程同时查询数据库的这条数据，可以在第一条数据的请求上使用一个互斥锁，其他线程走到这一步拿不到锁就等着，
等第一个线程查询到了数据后做缓存，后面的线程会直接走缓存

- **缓存雪崩**
1. 缓存雪崩概念
> 某一时刻发生大规模的缓存失效情况，比如缓存服务宕机了，会有大量的请求打到DB上
2. 解决方法
> 事前：使用集群缓存，保证服务高可用。
> 事中：ehcache本地缓存+Hystrix限流&降级，避免mysql被打死
> 事后：开启redis持久化机制，尽快恢复缓存集群

防止雪崩图
![](https://user-gold-cdn.xitu.io/2019/3/27/169bb265aa52e948?imageslim)

- **解决热点数据集中失效问题**
1. 一般数据都会设置失效时间，恰巧大量热点数据集中失效则会导致雪崩
2. 解决办法
> 设置不同的失效时间
> 增加互斥锁：第一个请求数据库是增加互斥锁，其余查询请求都被阻塞，查询到后加入缓存。由于会阻塞其他线程，
此刻会降低系统吞吐量，需结合实际业务决定是否这么做